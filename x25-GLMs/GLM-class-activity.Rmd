---
title: "GLM Class Activity"
output:
  html_document: default
language: R
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
 
 First, install and load the bbmle library
```{r}
install.packages('bbmle')
library(bbmle)
```
 
 We're going to do a Poisson regression using the fungus-induced mortality example
 
 Here is some code to generate the data we'll study
```{r}
## generating the data 
dry.wt.fungus <- runif(1e3,0,30)
mort.alpha <- -6
mort.beta <- 0.21
mortality <- rpois(length(dry.wt.fungus),lambda=exp(mort.alpha + mort.beta*dry.wt.fungus))

```

1)
Below is code for running a normal regression GLM using mle2(). Try running the code and discuss with your group whether you think this model is doing a good job of fitting the data.
 
```{r}

#define a deterministic funciton
detFunc <- function(x,a,b){
    return(a + b*x)
}

# specify the inverse link function
invLink <- function(z){
    return(z)
}

# run a regression with mle2()
mydata <- data.frame("x"= dry.wt.fungus,"y"= mortality)
mod <- mle2(y ~ dnorm(mean=invLink( detFunc(x,a,b)), sd=s),
            data=mydata,
            start=list("a"=0,"b"=0, 's'=1))

## use the model to generate data
modData = mod@coef[1]+mydata$x*mod@coef[2]

#get residuals from difference between actual data and the predicted data
residuals <- mydata$y - modData

## look at the model-predicted data curve on top of the actual data
plot(mydata$x, mydata$y, bty="n", col="darkgray")
points(mydata$x, modData,col="red",lwd=2)
  
## look at a histogram of the residuals
hist(residuals, col = "gray", border="white")
```


2) 

Now, try a Poisson regression. Head to wikipedia and look up the link function for a Poisson regression: https://en.wikipedia.org/wiki/Generalized_linear_model#Link_function

Code for running a Possion regression is below. I've added comments where things have changed from the previous version. Please discuss these changes with your group.

```{r}

#define a deterministic function
detFunc <- function(x,a,b){
    return(a + b*x)
}

# specify the inverse link function
invLink <- function(z){
    return(exp(z))  ### CHANGE -- this is the inverse-link function for the poisson distribution
}

# run a regression with mle2()
mydata <- data.frame("x"= dry.wt.fungus,"y"= mortality)
mod <- mle2(y ~ dpois(lambda=invLink( detFunc(x,a,b))), ### CHANGE -- dnorm has now become dpois, and instead of a mean and sigma, we have a lambda value for the rate parameter
            data=mydata,
            start=list("a"=0,"b"=0))  ## CHANGE -- we now only need to start with two parameters


## use the model to generate data
modData = exp(mod@coef[1]+mydata$x*mod@coef[2]) ##CHANGE -- we're using the inverse-link function to calculate the model-predicted data

#get residuals from difference between actual data and the predicted data
residuals <- mydata$y - modData

## look at the model-predicted data curve on top of the actual data
plot(mydata$x, mydata$y, bty="n", col="darkgray")
points(mydata$x, modData,col="red",lwd=2)
  
## look at a histogram of the residuals
hist(residuals, col = "gray", border="white")


```

Discuss this Poisson regression model with your group. Does it fit better than the normal GLM? If so, how do you know
\
\
I think the second model fits the data better because the residuals show a slightly better distribution around zero, although it's close. One lesson I take from this is that even when the data was generated through a non-normal process, the normal distribution can do a pretty good job of fitting the data!.