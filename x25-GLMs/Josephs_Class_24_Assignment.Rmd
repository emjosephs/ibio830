---
title: "Model Building: putting it all together"
output:
  html_document: default
  pdf_document: default
language: R
---

<!-- To render the assignment in Rmarkdown, enter the command below in the R console -->
<!-- rmarkdown::render("Class_24_Assignment.Rmd") -->

#### Due by the beginning of next class (12/3)

Save this Rmarkdown script as a file named “YourlastName_Assignment24.Rmd”. 
For each question, fill out the answer and, where requested, 
provide the relevant R code using "```" and the echo = TRUE argument.

When finished, Knit your script together into an html report, 
saved as “YourlastName_Assignment24.html” and upload the 
resulting file to the D2L site (in today’s class folder) to turn it in. 
It is due before our next class.

\

**This homework assignment will test your abilities to:**

1. think critically and creatively about model building

2. extrapolate from in-class exercises to simulate data and do inference with generalized linear models

3. hone your R skillz: function building, data visualization, etc.

\

### Question 1

Explain in your own words each of the terms in each of the equations below, 
as well as what each equation is doing, and what they are all doing together.

$Y_i \sim \mathcal{Pois}(\lambda_i=f(x_i))$ \
$\lambda = \text{exp}(f(x_i))$ \
$f(x_i) = \alpha + \beta x_i$ \

These functions describe a Poisson regression.
$Y_i$ is the ith instance of a response variable.
$x_i$ is the ith instance of a predictor variable.
$\lambda_i$ is the rate parameter of the Poisson distribution, from which $Y_{i}$ is modeled as a draw.
$f(x_i)$ is a function relating the predictor variable $x_i$ to the expected value for it's associated response variable.



### Question 2

Write mle2 code blocks for the following models.
For each, define an R function for the inverse link function and 
the deterministic function, and write out the mle2 call 
using a data frame with named columns "predictor" and "response".

A) Binomial regression (sample size of 15)

```{r}

##make the data
myPred = runif(15)
myResponse = rbinom(15, size=1,prob = myPred)
mydata <- data.frame("predictor"= myPred,"response"= myResponse)


# define a deterministic function
myDet <- function(x,a,b){
    return(a + b*x)
}

# define inverse link function
myInverse <- function(z){
    p <- 1/(1+exp(-z))
    return(p)
}

# run binomial regression with mle2()

library('bbmle')

mod <- mle2(response ~ dbinom(size=15, p=myInverse(myDet(predictor,a,b))),
            data=mydata,
            start=list("a"=0,"b"=0))

```

B) Poisson Regression

```{r}
myPred = runif(100)
myResponse = rpois(100, lambda=myPred)
mydata <- data.frame("predictor"= myPred,"response"= myResponse)

# define a deterministic function
myDet <- function(x,a,b){
    return(a + b*x)
}

# define inverse link function
myInverse <- function(z){
    return(exp(z))
}

# run binomial regression with mle2()


mod <- mle2(response ~ dpois(lambda=myInverse(myDet(predictor,a,b))),
            data=mydata,
            start=list("a"=0,"b"=0))


```

C) Linear model (aka Normal regression)

```{r}
myPred = runif(100, 0,10)
myResponse = rnorm(100, mean=myPred, sd=1)
mydata <- data.frame("predictor"= myPred,"response"= myResponse)

# define a deterministic function
myDet <- function(x,a,b){
    return(a + b*x)
}

# define inverse link function
myInverse <- function(z){
    return(z)
}

# run binomial regression with mle2()


mod <- mle2(response ~ dnorm(mean=myInverse(myDet(predictor,a,b)), sd=s),
            data=mydata,
            start=list("a"=0,"b"=0, 's'=1))
```


### Question 3

Use mle2 to infer the parameters of the model 
I used to simulate the data saved in the "mysteryData.Robj" 
file in the Class 24 homework folder on D2L.

Plot the line from the model you fit and also 
a histogram of the residuals (the observed data - 
their expected value for all data points).

```{r}

load('mysteryData.Robj')

plot(mysteryData$predictor, mysteryData$response)

##try exponential, changing the deterministic function
myDet <- function(a,b,x){
    return(a*x^b)
}
#no link function needed... why?
myInverse <- function(z){
    return(z)
}


mod <- mle2(response ~ dnorm(mean=myInverse(myDet(a,b,predictor)),sd=s),
            data=mysteryData,
            start=list("a"=rnorm(1),"b"=rnorm(1),"s"=abs(rnorm(1))))

mod

modelData = mod@coef[1]* mysteryData$predictor^mod@coef[2]

par(mfrow=c(1,2))
plot(mysteryData$predictor, mysteryData$response, bty="n", col="darkgray")
points(mysteryData$predictor, modelData,col="red",lwd=2)
  

  #get residuals from difference between actual data and the predicted data
residuals <- mysteryData$response - modelData

hist(residuals, col = "gray", border="white")

```



